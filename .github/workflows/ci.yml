name: Continuus Integration


on:
  pull_request:
    branches: [ master ]


env:
  java_version: "12.x"
  flutter_version: "2.5.3"
  codecov_token: ${{ secrets.CODECOV_TOKEN }}
  pexels_api_key: ${{ secrets.PEXELS_API_KEY }}


jobs:
  test:
    name: Testing, code quality and coverage reporting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v1
        with:
          java-version: ${{ env.java_version }} 
      - name: Cache Flutter dependencies
        uses: actions/cache@v1
        with:
          path: /opt/hostedtoolcache/flutter
          key: ${{ runner.OS }}-flutter-install-cache-${{ env.flutter_version }}
      - uses: subosito/flutter-action@v1
        with:
          flutter-version: ${{ env.flutter_version }}
      - name: Create environment file
        run: echo 'PEXELS_API_KEY=${{ env.pexels_api_key }}' > .env
      - name: Install dependencies
        run: flutter pub get
      - name: Run Flutter lint
        run: flutter analyze
      - name: Run tests and create coverage file
        run: flutter test --coverage
      - name: Report coverage file to codecov.io
        uses: codecov/codecov-action@v1
        with:
          token: ${{ env.codecov_token }}
          file: coverage/lcov.info
        
  build_appbundle:
    needs: [test]
    name: Build Flutter (Appbundle)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v1
        with:
          java-version: ${{ env.java_version }} 
      - name: Cache Flutter dependencies
        uses: actions/cache@v1
        with:
          path: /opt/hostedtoolcache/flutter
          key: ${{ runner.OS }}-flutter-install-cache-${{ env.flutter_version }}
      - uses: subosito/flutter-action@v1
        with:
          flutter-version: ${{ env.flutter_version }}
      - name: Create environment file
        run: echo 'PEXELS_API_KEY=${{ env.pexels_api_key }}' > .env
      - name: Install dependencies
        run: flutter pub get
      - name: Build
        run: flutter build appbundle

  build_ios:
    needs: [test]
    name: Build Flutter (iOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v1
        with:
          java-version: ${{ env.java_version }} 
      - name: Cache Flutter dependencies
        uses: actions/cache@v1
        with:
          path: /Users/runner/hostedtoolcache/flutter
          key: ${{ runner.OS }}-flutter-install-cache-${{ env.flutter_version }}
      - uses: subosito/flutter-action@v1
        with:
          flutter-version: ${{ env.flutter_version }}
      - name: Create environment file
        run: echo 'PEXELS_API_KEY=${{ env.pexels_api_key }}' > .env
      - name: Install dependencies
        run: flutter pub get
      - name: Build
        run: flutter build ios --no-codesign